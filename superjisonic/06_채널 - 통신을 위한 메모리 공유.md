# 06 ì±„ë„ - í†µì‹ ì„ ìœ„í•œ ë©”ëª¨ë¦¬ ê³µìœ 

ìƒì„±ì¼: 2023ë…„ 4ì›” 23ì¼ ì˜¤í›„ 3:27

ë™ì‹œì„±ì˜ ëŒ€ë¶€ë¶„ì˜ ì˜¤ë¥˜ â†’ ì„œë¡œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œ ê°„ì— ë©”ëª¨ë¦¬ë¥¼ ê³µìœ í• ë•Œ ë°œìƒ

- Deadlocks, Race condition, ì›ìì„± ìœ„ë°˜ â‡’ ê³µìœ  ìƒíƒœì™€ ê´€ë ¨ì´ ìˆìŒ

# ì±„ë„ì˜ ì´í•´

ì±„ë„: ë™ì‹œì„± ì½”ë“œ ê°„ì— ì„œë¡œ ì•ˆì „í•œ í†µì‹ ì„ í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ë„êµ¬

- ë™ì‹œì„± ì½”ë“œê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ í•´ì¤Œ
- ì‹¤í–‰ ì¤‘ì¸ ìŠ¤ë ˆë“œì— ìƒê´€ ì—†ì´ ì„œë¡œ ë‹¤ë¥¸ ì½”ë£¨í‹´ ê°„ì— ë©”ì‹œì§€ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ë‚´ê³  ë°›ê¸° ìœ„í•œ íŒŒì´í”„ë¼ì¸

![Untitled](06%20%E1%84%8E%E1%85%A2%E1%84%82%E1%85%A5%E1%86%AF%20-%20%E1%84%90%E1%85%A9%E1%86%BC%E1%84%89%E1%85%B5%E1%86%AB%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%86%E1%85%A6%E1%84%86%E1%85%A9%E1%84%85%E1%85%B5%20%E1%84%80%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%B2%209a2650a3576f42d3b3a1c3a01d620856/Untitled.jpeg)

- íŠ¹ì • í‚¤ì›Œë“œì— ëŒ€í•´ 10ê°œì˜ ì½˜í…ì¸  ì¸ë±ì„œë¥¼ ì¡°íšŒí•œ ë’¤ ê²€ìƒ‰ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²ƒ
    - ê° ì¸ë±ì„œë§ˆë‹¤ ì½”ë£¨í‹´ì„ ì‹œì‘í•´ì„œ Deferred<List<ResultDto>>ë¥¼ ë°˜í™˜

â‡’ ì¼ë¶€ëŠ” ìƒë‹¹íˆ ì˜¤ë˜ê±¸ë¦´ ìˆ˜ ìˆìŒ

1. search()ì—ì„œ Channel<ResultDto>ë¥¼ ë°˜í™˜í•˜ê²Œ ë³€ê²½
    1. ê²°ê³¼ê°€ ìˆ˜ì‹ ë˜ëŠ” ì¦‰ì‹œ UIë¡œ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.
    2. ê°€ì¥ì¢‹ì€ ì„ íƒ = ReceiveChannel<ResultDto>ë¥¼ ì‚¬ìš©
2. search()ì—ì„œ ê²°ê³¼ê°€ ë„ì°©í•˜ëŠ” ëŒ€ë¡œ ê° ì½”ë£¨í‹´ìœ¼ë¡œë¶€í„° ëŠê¹€ ì—†ì´ ê²°ê³¼ë¥¼ ìˆ˜ì‹ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë°©ë²•

â‡’ ê° ì½”ë£¨í‹´ì€ ì‘ë‹µì„ ê°€ì ¸ì˜¤ê³  ì²˜ë¦¬í• ë•Œ ë‹¨ì¼ ì±„ë„ì„ í†µí•´ì„œ ê²°ê³¼ë¥¼ ì „ì†¡í•¨

â‡’ search()ëŠ” í˜¸ì¶œìê°€ í¸ë¦¬í•˜ê²Œ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ê°„ë‹¨íˆ ì±„ë„ë§Œ ë°˜í™˜

![Untitled](06%20%E1%84%8E%E1%85%A2%E1%84%82%E1%85%A5%E1%86%AF%20-%20%E1%84%90%E1%85%A9%E1%86%BC%E1%84%89%E1%85%B5%E1%86%AB%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%86%E1%85%A6%E1%84%86%E1%85%A9%E1%84%85%E1%85%B5%20%E1%84%80%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%B2%209a2650a3576f42d3b3a1c3a01d620856/Untitled%201.jpeg)

ìš”ë¡œì¼€â€¦

<aside>
ğŸ’¡ ì½˜í…ì¸  ì¸ë±ì„œë¡œë¶€í„° ì–»ì€ ê²°ê³¼ë¥¼ ì¦‰ì‹œ ìˆ˜ì‹ í•˜ê²Œ ë˜ê³  UIëŠ” ê·¸ ê²°ê³¼ë¥¼ ì ì°¨ì ìœ¼ë¡œ í‘œì‹œ

</aside>

# ì±„ë„ ìœ í˜•ê³¼ ë°°ì••

Channelì˜ send()ëŠ” ì¼ì‹œ ì¤‘ë‹¨ í•¨ìˆ˜

â‡’ ì‹¤ì œë¡œ ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ëˆ„êµ°ê°€ê°€ ìˆì„ ë•Œê¹Œì§€ ì „ì†¡í•˜ëŠ” ì½”ë“œë¥¼ ì¼ì‹œì¤‘ì§€ í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸..

- ë°°ì•• (backpressure. ì—­ì••)
    - ë¦¬ì‹œë²„ê°€ ì‹¤ì œë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ê²ƒë³´ë‹¤ ë” ë§ì€ ìš”ì†Œë“¤ë¡œ ì±„ë„ì´ ë„˜ì¹˜ì§€ ì•Šë„ë¡ ë„ì™€ì¤Œ
    - ë°°ì••ì„ êµ¬ì„±í•˜ê¸° ìœ„í•´ ì±„ë„ì— ëŒ€í•œ **`ë²„í¼`**ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŒ
    - ì±„ë„ì„ í†µí•´ ë°ì´í„°ë¥¼ ë³´ë‚´ëŠ” ì½”ë£¨í‹´ â†’ ì±„ë„ì•ˆì˜ ìš”ì†Œê°€ ë²„í¼ í¬ê¸°ì— ë„ë‹¬í•˜ë©´ ì½”ë£¨í‹´ì€ ì¼ì‹œ ì¤‘ë‹¨ë¨
    - ì±„ë„ì—ì„œ ìš”ì†Œê°€ ì œê±°ë˜ëŠ” ì¦‰ì‹œ, ì†¡ì‹ ìëŠ” ë‹¤ì‹œ ì¬ê°œë¨

## ì–¸ë²„í¼ë“œ ì±„ë„

: ë²„í¼ê°€ ì—†ëŠ” Channel

### RendezvousChannel ë‘ë°ë·° ì±„ë„

- ì–¸ë²„í¼ë“œ ì±„ë„ì˜ ìœ ì¼í•œ êµ¬í˜„
- ë²„í¼ê°€ ì „í˜€ ì—†ì–´ì„œ ê·¸ ì±„ë„ì—ì„œ `send()` ì„ í˜¸ì¶œí•˜ë©´ ë¦¬ì‹œë²„ê°€ `receive()`ë¥¼ í˜¸ì¶œí•  ë•Œê¹Œì§€ ì¼ì‹œ ì¤‘ì§€ë¨

```kotlin
/**
 * Creating a RendezvousChannel.
 */
fun main(args: Array<String>) = runBlocking{
	val time = measureTimeMillis{
		val channel = Channel<Int>() // ë˜ëŠ” val channel = RendezvousChannel<Int>()
		val sender = GlobalScope.launch{
			repeat(10){
				channel.send(it)
	      println("Sent $it")
			}
	  }
	
		channel.receive()
	  channel.receive()
	}
	println("Took ${time}ms")
}
```

- Channel() / RendezvousChannel() ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.
- Channel()ì— ë²„í¼ìš©ëŸ‰ì„ ë„£ì§€ ì•Šìœ¼ë©´ â†’ ë‘ë°ë·° ì±„ë„ì„

ìœ„ ì½”ë“œëŠ” ìš”ì†Œê°€ ê²€ìƒ‰ë  ë–„ê¹Œì§€ ì‹¤í–‰ì„ ì¤‘ì§€í•œë‹¤

- ì±„ë„ì„ í†µí•´ ìµœëŒ€ 10ê°œê¹Œì§€ ìˆ«ìë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì§€ë§Œ, receive()ë¥¼ ë‘ ìš”ì†Œë§Œ í•˜ê¸° ë•Œë¬¸ì—, ë‘ ìš”ì†Œë§Œ ì „ì†¡ë¨

## ë²„í¼ë“œ ì±„ë„

ë²„í¼ë¥¼ ê°€ì§€ëŠ” ìœ í˜•ì˜ ì±„ë„ì´ë©°, ì±„ë„ ë‚´ ìš”ì†Œ ìˆ˜ê°€ ë²„í¼ í¬ê¸°ì™€ `ê°™ì„ë•Œ ë§ˆë‹¤` ì†¡ì‹ ìì˜ ì‹¤í–‰ì„ ì¤‘ì§€í•¨

### LinkedListChannel

ì¤‘ë‹¨ ì—†ì´ ë¬´í•œì˜ ìš”ì†Œë¥¼ ì „ì†¡í•  ìˆ˜ ìˆëŠ” ì±„ë„

- ì–´ë–¤ ì†¡ì‹ ìë„ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ
- Channel.UNLIMITED íŒŒë¼ë¯¸í„°ì™€ í•¨ê»˜ ì‚¬ìš© ê°€ëŠ¥
- ì•„ë˜ì˜ ì½”ë“œì—ì„œ 5ê°œì˜ ìš”ì†Œë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë¦¬ì‹œë²„ê°€ ì—†ì–´ë„ senderê°€ 5ê°œì˜ ìš”ì†Œë¥¼ ë‚´ë³´ë‚¼ ìˆ˜ ìˆë‹¤.

```kotlin
fun main(args: Array<String>) = runBlocking {
    val time = measureTimeMillis {
        val channel = Channel<Int>(Channel.UNLIMITED) //ë˜ëŠ” LinkedListChannel<INT>(Channel.UNLIMITED) ë¡œ ìƒì„±
        val sender = GlobalScope.launch {
            repeat(5) {
                println("Sending $it")
                channel.send(it)
            }
        }

        delay(500)
    }

    println("Took ${time}ms")
}
```

ì‹¤ì œë¡œëŠ” ë©”ëª¨ë¦¬ ìš©ëŸ‰ì´ ë‚´ë³´ë‚¼ ìˆ˜ ìˆëŠ” ìš”ì†Œì˜ ìˆ˜ì— ì œí•œì„ ì¤€ë‹¤.. ì´ ì±„ë„ì€ ë©”ëª¨ë¦¬ë¥¼ ë„ˆë¬´ ë§ì´ ì†Œë¹„í•  ìˆ˜ ìˆê¸°ë•Œë¬¸ì— ì£¼ì˜í•´ì•¼í•¨

### ArrayChannel

- ë²„í¼ í¬ê¸°ë¥¼ 0ë¶€í„° ìµœëŒ€ `int.MAX_VALUE -1` ê¹Œì§€ ê°€ì§„ë‹¤.
- ê°€ì§€ê³  ìˆëŠ” ìš”ì†Œì˜ ì–‘ì´ ë²„í¼ í¬ê¸°ì— ì´ë¥´ë©´ ì†¡ì‹ ìë¥¼ ì¼ì‹œ ì¤‘ë‹¨í•¨
- ë²„í¼ê°€ ê°€ë“ì°¨ë©´ ì†¡ì‹ ìë¥¼ ì¼ì‹œ ì¤‘ë‹¨í•¨
- ì•„ë˜ì˜ ì½”ë“œì—ì„œ senderê°€ 10ê°œì˜ ìš”ì†Œë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì§€ë§Œ ì±„ë„ìš©ëŸ‰ì´ 4ë¼ì„œ, 4ê°œë§Œ ë³´ë‚´ê³  ì¤‘ë‹¨ë¨
    - ë‘ ê°œì˜ ìš”ì†Œê°€ receive()ë˜ì—ˆê¸° ë•Œë¬¸ì—, senderëŠ” ë²„í¼ê°€ ë‹¤ì‹œ ì°°ë•Œê¹Œì§€ ì¬ê°œ

```kotlin
fun main(args: Array<String>) = runBlocking {
    val time = measureTimeMillis {
        val channel = Channel<Int>(4)//ë˜ëŠ” ArrayChannel<Int>(4)
        val sender = GlobalScope.launch {
            repeat(10) {
                channel.send(it)
                println("Sent $it")
            }
        }

        delay(500)

        println("Taking two")
        channel.take(2).receive()

        delay(500)
    }

    println("Took ${time}ms")
}
```

### ConflatedChannel

ë‚´ë³´ë‚¸ ìš”ì†Œê°€ ìœ ì‹¤ë˜ì–´ë„ ê´œì°®ë‹¤ëŠ” ê°€ì •ì„ ê¸°ë°˜ìœ¼ë¡œ í•¨

- í•˜ë‚˜ì˜ ìš”ì†Œì˜ ë²„í¼ë§Œ ê°–ê³  ìˆê³ , ìƒˆ ìš”ì†Œê°€ ë³´ë‚´ì§ˆ ë•Œë§ˆë‹¤ ì´ì „ ìš”ì†Œê°€ ìœ ì‹¤ë¨
- = ì†¡ì‹ ìê°€ ì ˆëŒ€ë¡œ ì¼ì‹œì¤‘ì§€ ë˜ì§€ ì•ŠìŒ
- ì±„ë„ì€ ì†¡ì‹ ìë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•Šê³ , ê°€ì ¸ì˜¤ì§€ ì•ŠëŠ” ìš”ì†Œë¥¼ ë®ì–´ì“´ë‹¤
    - ì•„ë˜ì˜ ì½”ë“œì—ì„œ ì±„ë„ì„ í†µí•´ ë§ˆì§€ë§‰ ê°’ì¸ 4ë¥¼ receiveí•¨

```kotlin
fun main(args: Array<String>) = runBlocking {
    val time = measureTimeMillis {
        val channel = Channel<Int>(Channel.CONFLATED)
        GlobalScope.launch {
            repeat(5) {
                channel.send(it)
                println("Sent $it")
            }
        }
        delay(500)
        val element = channel.receive()
        println("Received $element")
    }

    println("Took ${time}ms")
}
```

ã…‡

# ì±„ë„ê³¼ ìƒí˜¸ì‘ìš©

channel<T>ì˜ ë™ì‘ì€ SendChannel<T>ì™€ ReceiveChannel<T>ì˜ ë‘ ê°œì˜ ì¸í„°í˜ì´ìŠ¤ë¡œ ì´ë£¨ì–´ì ¸ìˆìŒ

## SendChannel

ì±„ë„ì„ í†µí•´ ìš”ì†Œë¥¼ ë³´ë‚´ê¸° ìœ„í•œ ëª‡ê°œì˜ í•¨ìˆ˜ì™€, ì´ë¥¼ ê²€ì¦í•˜ê¸° ìœ„í•œ ë‹¤ë¥¸ í•¨ìˆ˜ë¥¼ ì •ì˜í•¨

### ë³´ë‚´ê¸° ì „ ê²€ì¦

ì±„ë„ì„ í†µí•´ ìš”ì†Œë¥¼ ë³´ë‚´ê¸° ì „ì— ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ê²€ì¦ ë°©ë²•ì´ ìˆìŒ

- ì „ì†¡ì„ ìœ„í•œ ì±„ë„ì´ ë‹«íˆì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸

```kotlin
fun isClosed() {
    val channel = Channel<Int>()
    channel.isClosedForSend // false
    channel.close()
    channel.isClosedForSend // true
}
```

- ì±„ë„ ìš©ëŸ‰ì´ ë¶€ì¡±í•œì§€ ì²´í¬
    - ì±„ë„ì´ ê°€ë“ ì°¨ë©´ ë‹¤ìŒ sendë¥¼ í˜¸ì¶œí•œ ë‹¤ìŒì— ì±„ë„ì´ ì¼ì‹œì¤‘ë‹¨ë˜ë¯€ë¡œ, í˜„ì¬ ì½”ë£¨í‹´ì„ ì¼ì‹œ ì¤‘ë‹¨í•˜ê³  ì‹¶ì§€ ì•Šì„ë•Œ ìœ ìš©

```kotlin
suspend fun isFull() {
    val channel = Channel<Int>(1)
    //channel.isFull // false   // Deprecated (https://github.com/Kotlin/kotlinx.coroutines/issues/1053)
    channel.send(1)
    //channel.isFull // true   // Deprecated (https://github.com/Kotlin/kotlinx.coroutines/issues/1053)
}
```

â‡’ deprecatedë˜ì—ˆë‹¤ê³  í•¨â€¦

### ìš”ì†Œ ì „ì†¡

send() ë¡œ ì±„ë„ì„ í†µí•´ ìš”ì†Œë¥¼ ì „ì†¡í•œë‹¤.

- BufferedChannelì—ì„œ ë²„í¼ê°€ ê°€ë“ì°¨ë©´ ì†¡ì‹ ìë¥¼ ì¼ì‹œ ì¤‘ë‹¨í•¨
- ë‘ë°ë·°ì±„ë„ì´ë©´ receive()ê°€ í˜¸ì¶œë ë•Œê¹Œì§€ suspend
- ì±„ë„ì´ ë‹«íˆë©´ send()í•¨ìˆ˜ëŠ” ClosedChannelExceptionì„ ë˜ì§

```kotlin
suspend fun send() {
    val channel = Channel<Int>(1)
    channel.send(1)
}

suspend fun sendException() {
    val channel = Channel<Int>(1)
    channel.close()

    try {
        channel.send(1)
    } catch (e : ClosedSendChannelException) {
        println("ClosedSendChannelException handled")
    }

}
```

### ìš”ì†Œ ì œê³µ

- íŠ¹ì • ìƒí™©ì—ì„œ ì±„ë„ì„ í†µí•´ ìš”ì†Œë¥¼ ë³´ë‚¼ ìˆ˜ ìˆëŠ” ë¹„ ì¼ì‹œì¤‘ë‹¨ (non-suspending) í•¨ìˆ˜ê°€ ìˆë‹¤
- offer()í•¨ìˆ˜
    - ëŒ€ê¸°ì—´ì— ì¶”ê°€í•  ìš”ì†Œë¥¼ ê°€ì§€ë©°, ì±„ë„ì˜ ìƒíƒœì— ë”°ë¼ Booleanì„ ë°˜í™˜/ë˜ëŠ” ì˜ˆì™¸ë˜ì§

```kotlin
fun offerException() {
    val channel = Channel<Int>(1)
    channel.close()

    try {
        channel.offer(10)
    } catch (e : ClosedSendChannelException) {
        println("ClosedSendChannelException handled")
    }
}

suspend fun offerWhenFull() {
    val channel = Channel<Int>(1)
    channel.send(1)
    channel.offer(2) // false
}

suspend fun offer() {
    val channel = Channel<Int>(1)
    channel.offer(2) // false
    channel.receive() // 2
}
```

### ì±„ë„ì´ ë‹«íŒ ìƒíƒœ

channel.isClosedForSend = true ì´ë©´

offer()ëŠ” ClosedChannelExceptionì„ ë˜ì§

### ì±„ë„ì´ ê°€ë“ ì°¬ ìƒíƒœ

isFull= trueë©´ offer()ëŠ” ê°„ë‹¨íˆ falseë¥¼ ë°˜í™˜í•¨..

### ì±„ë„=open, isFull=false

ì´ë•ŒëŠ” offer()ê°€ ìš”ì†Œë¥¼ ëŒ€ê¸°ì—´ì— ì¶”ê°€í•œë‹¤. suspend ì—°ì‚°ì—ì„œ ë°œìƒí•˜ì§€ ì•ŠëŠ” ì±„ë„ì— ìš”ì†Œë¥¼ ì¶”ê°€í•˜ëŠ” ìœ ì¼í•œ ë°©ë²•

â‡’ ë‚˜ë§Œ ì´ê±° í•´ì„ ì•ˆë¨?

# ReceiveChannel

## isClosedForReceive

ìˆ˜ì‹ ì— ëŒ€í•´ ë‹«íŒ ì±„ë„ì¸ì§€ ì—¬ë¶€

ë‹«íŒ ì±„ë„ì—ì„œ receiveí˜¸ì¶œì‹œ ì˜ˆì™¸ë°œìƒ

```kotlin
fun isClosedForReceive() {
    val channel = Channel<Int>()
    channel.isClosedForReceive // false
    channel.close()
    channel.isClosedForReceive // true
}

suspend fun receiveException() {
    val channel = Channel<Int>()
    channel.close()

    try {
        channel.receive()
    } catch (e: ClosedReceiveChannelException) {
        println("ClosedReceiveChannelException handled")
    }
}

```

## isEmpty

ìˆ˜ì‹ í•  ê²ƒì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì—¬ë¶€

suspend fun isEmpty() {
    val channel = Channel<Int>(1)
    channel.isEmpty // true
    channel.send(10)
    channel.isEmpty // false
}